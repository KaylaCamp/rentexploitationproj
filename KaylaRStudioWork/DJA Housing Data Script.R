#census_api_key("458aa9bc797be35b8c9b994f1c9b9760f35a8c1a", install = TRUE, overwrite = TRUE )
readRenviron("~/.Renviron")

# Pull data for Rent Exploitation Analysis
# Charlottesville region
library(tidycensus)
library(tidyverse)


# Tract-level Variables from American Community Survey
# Median gross rent: B25064
# Median real estate taxes: B25103

# Define region
cvl <- c("003", "540", "079","109", "065", "125")
# Albemarle: 003; Charlottesville: 540; Greene: 079; Louisa: 109; Nelson: 125; Fluvanna: 065

vars <- c(MedRent="B25064_001", MedTax="B25103_001", MedRenterHHIncome="B25119_003", MedRentHHIncome="B25071_001")
#B25071 MedianGross rent as percentage of household income
#B25077 MEDIAN VALUE (DOLLARS)
#B19083 Gini Index of Income Inequality - 
#B25121  HOUSEHOLD INCOME IN THE PAST 12 MONTHS (IN 2020 INFLATION-ADJUSTED DOLLARS) BY VALUE
#B25106  TENURE BY HOUSING COSTS AS A PERCENTAGE OF HOUSEHOLD INCOME IN THE PAST 12 MONTHS
#B25118  TENURE BY HOUSEHOLD INCOME IN THE PAST 12 MONTHS (IN 2020 INFLATION-ADJUSTED DOLLARS)
#B25003  TENURE

cvl_rent1 <- get_acs(geography = "tract",
                    variables = vars,
                    year = 2020,
                    state = "51",
                    survey = "acs5",
                    county = cvl,
                    output = "tidy")

cvl_rent2 <- get_acs(geography = "tract",
                     variables = vars,
                     year = 2020,
                     state = "51",
                     survey = "acs5",
                     county = cvl,
                     output = "wide")

tenure <- get_acs(geography = "tract",
                     table = "B25003", 
                     year = 2020,
                     state = "51",
                     survey = "acs5",
                     county = cvl,
                     output = "wide",)
tenure <- rename(tenure, TotalE="B25003_001E", TotalMOE="B25003_001M",OwnerOcE="B25003_002E", OwnerOcMOE="B25003_002M",RenterOcE="B25003_003E", RenterOcMOE="B25003_003M")

# Wrangling
# rename variables
  
#cvl_rent2 <- rename(cvl_rent2,MedRentEst= B25064_001E, MedRentMOE = B25064_001M, MedTaxEst= B25103_001E, MedTaxMOE = B25103_001M,MedHHIncomeEst=B19013_001M, MedHHIncomeMOE=B19013_001M)

# create rent/tax ratio
cvl_rent2 <- cvl_rent2 %>% 
  mutate(RentTaxRatE= MedRentE/MedTaxE , 
         RentTaxRatMOE= moe_ratio(MedRentE,MedTaxE, MedRentM, MedTaxM))

# add variable for locality: str_contains
cvl_rent2<- cvl_rent2 %>%
  mutate(FipCodes=str_sub(GEOID,3,5)) %>% 
  mutate(County = case_when(
    FipCodes== "540" ~ "Charlottesville",
    FipCodes== "109" ~"Louisa",
    FipCodes== "125" ~"Nelson",
    FipCodes=="065"~"Fluvanna",
    FipCodes=="003"~"Albemarle",
    FipCodes=="079"~"Greene",
  ))

#ordering the columns to place "County" next to "GEOID"
cvl_rent2 <- select(cvl_rent2, 1, 2, 13, 14, 3, 4, 5, 6, 11, 12, 7, 8, 9, 10)

# save/output prepped data

write.csv(cvl_rent2,"~/UVA Data Justice/rentexploitationproj/KaylaRStudioWork/CensusHousingData2020.csv", row.names=FALSE)
#/UVA Data Justice/rentexploitationproj/KaylaRStudioWork/
#~/UVA Data Justice/rentexploitationproj/KaylaRStudioWork

# Try reading in exported data to R markdown
# Basic exploration of data 

