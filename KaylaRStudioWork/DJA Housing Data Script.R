#census_api_key("458aa9bc797be35b8c9b994f1c9b9760f35a8c1a", install = TRUE, overwrite = TRUE )
readRenviron("~/.Renviron")

# Pull data for Rent Exploitation Analysis
# Charlottesville region
library(tidycensus)
library(tidyverse)



# Tract-level Variables from American Community Survey
# Median gross rent: B25064
# Median real estate taxes: B25103

# Define region
cvl <- c("003", "540", "079","109", "065", "125", "760", "087","041", "670", "730")
#Charlottesville Region Fips: Albemarle: 003; Charlottesville: 540; Greene: 079; Louisa: 109; Nelson: 125; Fluvanna: 065
#Richmond Region Fips: Richmond City: 760; Henrico County: 087; Chesterfield County: 041; Hopewell City: 670; Petersburg City: 730

vars <- c(MedRent="B25064_001", MedTax="B25103_001", MedRenterHHIncome="B25119_003", MedRentBurdenPerc="B25071_001")
#B25071 MedianGross rent as percentage of household income
#B25077 MEDIAN VALUE (DOLLARS)
#B25121  HOUSEHOLD INCOME IN THE PAST 12 MONTHS (IN 2020 INFLATION-ADJUSTED DOLLARS) BY VALUE
#B25106  TENURE BY HOUSING COSTS AS A PERCENTAGE OF HOUSEHOLD INCOME IN THE PAST 12 MONTHS
#B25118  TENURE BY HOUSEHOLD INCOME IN THE PAST 12 MONTHS (IN 2020 INFLATION-ADJUSTED DOLLARS)
#B25003  TENURE
#Additional Variables
  #B160016 LANGUAGE SPOKEN AT HOME BY ABILITY TO SPEAK ENGLISH FOR THE POPULATION 5 YEARS AND OVER (HISPANIC OR LATINO)
  #B19083 Gini Index of Income Inequality - 
  #B14007 SCHOOL ENROLLMENT BY DETAILED LEVEL OF SCHOOL FOR THE POPULATION 3 YEARS AND OVER (_17 Undergrad, _18 Grad Program)
  #B02001 Race
  #S1701  POVERTY STATUS IN THE PAST 12 MONTHS
  #B99163  ALLOCATION OF ABILITY TO SPEAK ENGLISH FOR THE POPULATION 5 YEARS AND OVER



cvl_rent1 <- get_acs(geography = "tract",
                    variables = vars,
                    year = 2020,
                    state = "51",
                    survey = "acs5",
                    county = cvl,
                    output = "tidy")

cvl_rent2 <- get_acs(geography = "tract",
                     variables = vars,
                     year = 2020,
                     state = "51",
                     survey = "acs5",
                     county = cvl,
                     output = "wide")

tenure <- get_acs(geography = "tract",
                     table = "B25003", 
                     year = 2020,
                     state = "51",
                     survey = "acs5",
                     county = cvl,
                     output = "wide",)
tenure <- rename(tenure, TotalE="B25003_001E", TotalMOE="B25003_001M",OwnerOcE="B25003_002E", OwnerOcMOE="B25003_002M",RenterOcE="B25003_003E", RenterOcMOE="B25003_003M")

racevars<-c(WhiteOwners="B25003A_002", WhiteRenters="B25003A_003", BlackOwners="B25003B_002", BlackRenters="B25003B_003", 
            NativeAmOwners="B25003C_002", NativeAmRenters="B25003C_003", AsianOwners="B25003D_002", AsianRenters="B25003D_003", 
            PacificIslandOwners="B25003E_002", PacificIslandRenters="B25003E_003", HispanicLatinoOwners="B25003I_002", HispanicLatinoRenters="B25003I_003")
TenureByRace<-get_acs(geography = "tract",
                      variables= racevars,
                      year = 2020,
                      state = "51",
                      survey = "acs5",
                      county = cvl,
                      output = "wide",)

racevars<-c(WhiteOwners="B25003A_002", WhiteRenters="B25003A_003", BlackOwners="B25003B_002", BlackRenters="B25003B_003", 
            NativeAmOwners="B25003C_002", NativeAmRenters="B25003C_003", AsianOwners="B25003D_002", AsianRenters="B25003D_003", 
            PacificIslandOwners="B25003E_002", PacificIslandRenters="B25003E_003", HispanicLatinoOwners="B25003I_002", HispanicLatinoRenters="B25003I_003")
TenureByRace<-get_acs(geography = "tract",
                      variables= racevars,
                      year = 2020,
                      state = "51",
                      survey = "acs5",
                      county = cvl,
                      output = "wide",)

#loading poverty by race dataset
povertyvars<-(WhiteTotal="S1701_C01_013", BlackTotal="S1701_C01_014", NativeAmerTotal="S1701_C01_015", AsianTotal="S1701_C01_016", NativeHawTotal="S1701_C01_017", OtherRacesTotal="S1701_C01_018", HispanicLatinoAloneTotal="S1701_C01_020", 
              WhitePovertyTotal="S1701_C02_013", BlackPovertyTotal="S1701_C02_014", NativeAmerPovertyTotal="S1701_C02_015", AsianPovertyTotal="S1701_C02_016", NativeHawPovertyTotal="S1701_C02_017", OtherRacesPovertyTotal="S1701_C02_018", HispanicLatinoAlonePovertyTotal="S1701_C02_020",
              WhitePovertyPerc="S1701_C03_013", BlackPovertyPerc="S1701_C03_014", NativeAmerPovertyPerc="S1701_C03_015", AsianPovertyPerc="S1701_C03_016", NativeHawPovertyPerc="S1701_C03_017", OtherRacesPovertyPerc="S1701_C03_018", HispanicLatinoAlonePovertyPerc="S1701_C03_020",   
              
#draft questions
#finish poverty dataset, try to find general poverty, add poverty above (B17020), add gini index
#add education enrollment
              

# Wrangling
# rename variables
  
#cvl_rent2 <- rename(cvl_rent2,MedRentEst= B25064_001E, MedRentMOE = B25064_001M, MedTaxEst= B25103_001E, MedTaxMOE = B25103_001M,MedHHIncomeEst=B19013_001M, MedHHIncomeMOE=B19013_001M)
# create rent/tax ratio
cvl_rent2 <- cvl_rent2 %>% 
  mutate(RentTaxRatE= MedRentE/MedTaxE , 
         RentTaxRatMOE= moe_ratio(MedRentE,MedTaxE, MedRentM, MedTaxM))



# add variable for locality: str_contains
cvl_rent2<- cvl_rent2 %>%
  mutate(FipCodes=str_sub(GEOID,3,5)) %>% 
  mutate(County = case_when(
    FipCodes=="540"~"Charlottesville",
    FipCodes=="109"~"Louisa",
    FipCodes=="125"~"Nelson",
    FipCodes=="065"~"Fluvanna",
    FipCodes=="003"~"Albemarle",
    FipCodes=="079"~"Greene",
    FipCodes=="760"~"Richmond City",
    FipCodes=="087"~"Henrico County",
    FipCodes=="041"~"Chesterfield County", 
    FipCodes=="670"~"Hopewell City", 
    FipCodes=="730"~"Petersburg City"
    
  ))

cvl_rent2<-cvl_rent2 %>% 
  mutate(Region=case_when(
    FipCodes %in% c("540","109","125", "065", "003", "079")~"Charlottesville",
    FipCodes %in% c("760","087","041", "670", "730")~"Richmond"
  ))

#ordering the columns to place "County" next to "GEOID"
cvl_rent2 <- select(cvl_rent2, 1, 2, 13, 14, 3, 4, 5, 6, 11, 12, 7, 8, 9, 10)

# save/output prepped data

write.csv(cvl_rent2,"~/UVA Data Justice/rentexploitationproj/KaylaRStudioWork/CensusHousingData2020.csv", row.names=FALSE)
write.csv(tenure,"~/UVA Data Justice/rentexploitationproj/KaylaRStudioWork/TenureData.csv", row.names=FALSE)
write.csv(TenureByRace,"~/UVA Data Justice/rentexploitationproj/KaylaRStudioWork/TenureByRaceData.csv", row.names=FALSE)

#/UVA Data Justice/rentexploitationproj/KaylaRStudioWork/
#~/UVA Data Justice/rentexploitationproj/KaylaRStudioWork

# Try reading in exported data to R markdown
# Basic exploration of data 

CensusHousingData %>% 
  ggplot()+
  geom_sf(aes(fill= RentTaxRatE))+
  geom_sf_label(aes(label = County), size=3, color ="black", fontface = "bold")+
  theme_void()
  
ggplot(cvl_rents)+
  geom_sf(aes(fill=rent))

