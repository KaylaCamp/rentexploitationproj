# Pull data for Rent Exploitation Analysis
# Charlottesville region

library(tidycensus)
library(tidyverse)

# Tract-level Variables from American Community Survey
# Median gross rent: B25064
# Median real estate taxes: B25103
# MEDIAN GROSS RENT AS A PERCENTAGE OF HOUSEHOLD INCOME: B25071 
# Median Household Income: B19013
# Tenure: B25003(s)
# MEDIAN HOUSEHOLD INCOME BY TENURE : B25119 (s)
# TENURE BY HOUSEHOLD INCOME : B25118 
#GINI INDEX: B19083
#educational enrollment: b14007







#(add percent for college studemts, add gini index, draft questions)
# 
# Define region

cvl <- c("003", "540", "079","109", "065", "125", "760", "087", "041", "670", "730")



# Albemarle: 003; Charlottesville: 540; Greene: 079; Louisa: 109; Nelson: 125; Fluvanna: 065
#Richmond City: 760, Henrico County: 087, Chesterfield County: 041, Hopewell City: 670, Petersburg City: 730

vars <- c(MedianRent = "B25064_001", MedianTaxes = "B25103_001", MedianIncome = "B19013_001", PercRent0fIncome = "B25071_001", Total_Pop = "B14007_001", Undergrad_Pop = "B14007_017", Grad_Pop = "B14007_018")


#tidy output
cvl_rent1 <- get_acs(geography = "tract",
                     variables = vars,
                     year = 2020,
                     state = "51",
                     survey = "acs5",
                     county = cvl,
                     output = "tidy")

#wide output
cvl_rent2 <- get_acs(geography = "tract",
                     variables = vars,
                     year = 2020,
                     state = "51",
                     survey = "acs5",
                     county = cvl,
                     output = "wide")


#Table for Tenure by Household Income
TenureByIncome <- get_acs(geography = "tract",
                          table = "B25118",
                          year = 2020,
                          state = "51",
                          survey = "acs5",
                          county = cvl,
                          output = "tidy")

#Table for Income by Tenure
IncomeByTenure <- get_acs(geography = "tract",
                          table = "B25119",
                          year = 2020,
                          state = "51",
                          survey = "acs5",
                          county = cvl,
                          output = "wide")

#Table for Tenure (renter or owner)
Tenure <- get_acs(geography = "tract",
                  table = "B25003",
                  year = 2020,
                  state = "51",
                  survey = "acs5",
                  county = cvl,
                  output = "wide")

racevars <- c(White_owners = "B25003A_002", White_renters = "B25003A_003", Black_owners = "B25003B_002",
              Black_renters = "B25003B_003", NativeAm_owners = "B25003C_002", NativeAm_renters = "B25003C_003", 
              Asian_owners = "B25003D_002", Asian_renters = "B25003D_003", PacificIslander_owner = "B25003E_002", 
              PacificIslander_renter = "B25003E_003", HispanicLatino_owner = "B25003I_002", 
              HispanicLation_renter = "B25003I_003")
TenureByRace <- get_acs(geography = "tract",
                  variables = racevars,
                  year = 2020,
                  state = "51",
                  survey = "acs5",
                  county = cvl,
                  output = "wide")

#Gini Index Table also included
Povertyvars <- c(BelowPoverty_White = "B17020A_002", AbovePoverty_White = "B17020A_010", BelowPoverty_Black = "B17020B_002",
                 AbovePoverty_Black = "B17020B_010", BelowPoverty_NativeAm = "B17020C_002", AbovePoverty_NativeAm = "B17020C_010", 
                 BelowPoverty_Asian = "B17020D_002", AbovePoverty_Asian = "B17020D_010", BelowPoverty_PacificIslander = "B17020E_002", 
                AbovePoverty_PacificIslander = "B17020E_010", BelowPoverty_HispanicLatino = "B17020I_002", 
                AbovePoverty_HispanicLatino = "B17020I_010", Gini_Index = "B19083_001")
PovertyByRace <- get_acs(geography = "tract",
                         variables = Povertyvars,
                         year = 2020,
                         state = "51",
                         survey = "acs5",
                         county = cvl,
                         output = "wide")
PovertyByRace <- PovertyByRace %>%
  mutate(Perc_BelowPoverty_WhiteE = round((BelowPoverty_WhiteE/(BelowPoverty_WhiteE + AbovePoverty_WhiteE))*100, 2),
         Perc_BelowPoverty_BlackE = round((BelowPoverty_BlackE/(BelowPoverty_BlackE + AbovePoverty_BlackE))*100, 2),
         Perc_BelowPoverty_AsianE = round((BelowPoverty_AsianE/(BelowPoverty_AsianE + AbovePoverty_AsianE))*100, 2),
         Perc_BelowPoverty_PacificIslanderE = round((BelowPoverty_PacificIslanderE/(BelowPoverty_PacificIslanderE + AbovePoverty_PacificIslanderE))*100, 2),
         Perc_BelowPoverty_NativeAmE = round((BelowPoverty_NativeAmE/(BelowPoverty_NativeAmE + AbovePoverty_NativeAmE))*100, 2),
         Perc_BelowPoverty_HispanicLatinoE = round((BelowPoverty_HispanicLatinoE/(BelowPoverty_HispanicLatinoE + AbovePoverty_HispanicLatinoE))*100, 2),
         Perc_BelowPoverty_WhiteM = round((BelowPoverty_WhiteM/(BelowPoverty_WhiteM + AbovePoverty_WhiteM))*100, 2),
         Perc_BelowPoverty_BlackM = round((BelowPoverty_BlackM/(BelowPoverty_BlackM + AbovePoverty_BlackM))*100, 2),
         Perc_BelowPoverty_AsianM = round((BelowPoverty_AsianM/(BelowPoverty_AsianM + AbovePoverty_AsianM))*100, 2),
         Perc_BelowPoverty_PacificIslanderM = round((BelowPoverty_PacificIslanderM/(BelowPoverty_PacificIslanderM + AbovePoverty_PacificIslanderM))*100, 2),
         Perc_BelowPoverty_NativeAmM = round((BelowPoverty_NativeAmM/(BelowPoverty_NativeAmM + AbovePoverty_NativeAmM))*100, 2),
         Perc_BelowPoverty_HispanicLatinoM = round((BelowPoverty_HispanicLatinoM/(BelowPoverty_HispanicLatinoM + AbovePoverty_HispanicLatinoM))*100, 2)) 





# Wrangling
# rename variables
# create rent/tax ratio
# add variable for locality: str_contains
# save/output prepped data
# Try reading in exported data to R markdown
# Basic exploration of data 



#chanigng column names, creating rent/tax ratio, adding new column for county, reording columns

cvlcharlottlesville <- c("003", "540", "079","109", "065", "125")
cvlrichmond <- c("760", "087", "041", "670", "730")

cvl_rent2 <- cvl_rent2 |>
  mutate(RentTaxRatio = MedianRentE/MedianTaxesE, 
         RentTaxRatioMOE = moe_ratio(MedianRentE, MedianTaxesE, MedianRentM, MedianTaxesM),
         County_fips = str_sub(GEOID, 3,5), 
         County = case_when(
    str_detect(GEOID, "51540") ~ "Charlottesville", 
    str_detect(GEOID, "51109") ~ "Louisa",
    str_detect(GEOID, "51125") ~ "Nelson",
    str_detect(GEOID, "51065") ~ "Fluvanna",
    str_detect(GEOID, "51003") ~ "Albemarle",
    str_detect(GEOID, "51079") ~ "Greene",
    str_detect(GEOID, "51760") ~ "Richmond City", 
    str_detect(GEOID, "51087") ~ "Henrico",
    str_detect(GEOID, "51041") ~ "Chesterfield",
    str_detect(GEOID, "51670") ~ "Hopewell",
    str_detect(GEOID, "51730") ~ "Petersburg City"
  ), 
  Region = case_when(
    County_fips %in% cvlcharlottlesville ~ "Charlottlesville",
    County_fips %in% cvlrichmond ~ "Richmond"
  ),
  Perc_StudentsE = round(((Undergrad_PopE + Grad_PopE)/(Total_PopE))*100, 2),
  Perc_StudentsM = round(((Undergrad_PopM + Grad_PopM)/(Total_PopM))*100, 2))|>
  select(1, 19, 2, 20, 21, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 22, 23)

#cvl_rent2 <- cvl_rent2 %>% 
 # select(1, 13, 2, 14, 15, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12)


TenureByRace <- TenureByRace %>% 
  mutate(County_fips = str_sub(GEOID, 3,5), 
County = case_when(
  str_detect(GEOID, "51540") ~ "Charlottesville", 
  str_detect(GEOID, "51109") ~ "Louisa",
  str_detect(GEOID, "51125") ~ "Nelson",
  str_detect(GEOID, "51065") ~ "Fluvanna",
  str_detect(GEOID, "51003") ~ "Albemarle",
  str_detect(GEOID, "51079") ~ "Greene",
  str_detect(GEOID, "51760") ~ "Richmond City", 
  str_detect(GEOID, "51087") ~ "Henrico",
  str_detect(GEOID, "51041") ~ "Chesterfield",
  str_detect(GEOID, "51670") ~ "Hopewell",
  str_detect(GEOID, "51730") ~ "Petersburg City"
), 
Region = case_when(
  County_fips %in% cvlcharlottlesville ~ "Charlottlesville",
  County_fips %in% cvlrichmond ~ "Richmond"
)) |>
  select(1, 27, 2, 28, 29, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26)

PovertyByRace <- PovertyByRace %>% 
  mutate(County_fips = str_sub(GEOID, 3,5), 
         County = case_when(
           str_detect(GEOID, "51540") ~ "Charlottesville", 
           str_detect(GEOID, "51109") ~ "Louisa",
           str_detect(GEOID, "51125") ~ "Nelson",
           str_detect(GEOID, "51065") ~ "Fluvanna",
           str_detect(GEOID, "51003") ~ "Albemarle",
           str_detect(GEOID, "51079") ~ "Greene",
           str_detect(GEOID, "51760") ~ "Richmond City", 
           str_detect(GEOID, "51087") ~ "Henrico",
           str_detect(GEOID, "51041") ~ "Chesterfield",
           str_detect(GEOID, "51670") ~ "Hopewell",
           str_detect(GEOID, "51730") ~ "Petersburg City"
         ), 
         Region = case_when(
           County_fips %in% cvlcharlottlesville ~ "Charlottlesville",
           County_fips %in% cvlrichmond ~ "Richmond"
         )) |>
  select(1, 27, 2, 28, 29, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26)



write.csv(cvl_rent2, "C:/Users/smang/OneDrive/Housing Justice DJA/rentexploitationproject/Data Cleaning/Housing_Data.csv", row.names = FALSE)
write.csv(IncomeByTenure, "C:/Users/smang/OneDrive/Housing Justice DJA/rentexploitationproject/Data Cleaning/Income_By_Tenure.csv", row.names = FALSE)
write.csv(Tenure, "C:/Users/smang/OneDrive/Housing Justice DJA/rentexploitationproject/Data Cleaning/Tenure.csv", row.names = FALSE)
write.csv(TenureByIncome, "C:/Users/smang/OneDrive/Housing Justice DJA/rentexploitationproject/Data Cleaning/Tenure_By_Income.csv", row.names = FALSE)
write.csv(TenureByRace, "C:/Users/smang/OneDrive/Housing Justice DJA/rentexploitationproject/Data Cleaning/Tenurebyrace.csv", row.names = FALSE)
write.csv(PovertyByRace, "C:/Users/smang/OneDrive/Housing Justice DJA/rentexploitationproject/Data Cleaning/ Povertybyrace.csv", row.names = FALSE)


