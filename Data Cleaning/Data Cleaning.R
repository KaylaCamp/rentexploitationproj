# Pull data for Rent Exploitation Analysis
# Charlottesville region

library(tidycensus)
library(tidyverse)

# Tract-level Variables from American Community Survey
# Median gross rent: B25064
# Median real estate taxes: B25103
# MEDIAN GROSS RENT AS A PERCENTAGE OF HOUSEHOLD INCOME: B25071 
# Median Household Income: B19013
# Tenure: B25003(s)
# MEDIAN HOUSEHOLD INCOME BY TENURE : B25119 (s)
# TENURE BY HOUSEHOLD INCOME : B25118 
# 
# Define region

cvl <- c("003", "540", "079","109", "065", "125")

# Albemarle: 003; Charlottesville: 540; Greene: 079; Louisa: 109; Nelson: 125; Fluvanna: 065

vars <- c(MedianRent = "B25064_001", MedianTaxes = "B25103_001", MedianIncome = "B19013_001", PercRent0fIncome = "B25071_001")


#tidy output
cvl_rent1 <- get_acs(geography = "tract",
                     variables = vars,
                     year = 2020,
                     state = "51",
                     survey = "acs5",
                     county = cvl,
                     output = "tidy")

#wide output
cvl_rent2 <- get_acs(geography = "tract",
                     variables = vars,
                     year = 2020,
                     state = "51",
                     survey = "acs5",
                     county = cvl,
                     output = "wide")


#Table for Tenure by Household Income
TenureByIncome <- get_acs(geography = "tract",
                          table = "B25118",
                          year = 2020,
                          state = "51",
                          survey = "acs5",
                          county = cvl,
                          output = "wide")

#Table for Income by Tenure
IncomeByTenure <- get_acs(geography = "tract",
                          table = "B25119",
                          year = 2020,
                          state = "51",
                          survey = "acs5",
                          county = cvl,
                          output = "wide")

#Table for Tenure (renter or owner)
Tenure <- get_acs(geography = "tract",
                  table = "B25003",
                  year = 2020,
                  state = "51",
                  survey = "acs5",
                  county = cvl,
                  output = "wide")




# Wrangling
# rename variables
# create rent/tax ratio
# add variable for locality: str_contains
# save/output prepped data
# Try reading in exported data to R markdown
# Basic exploration of data 



#chanigng column names, creating rent/tax ratio, adding new column for county, reording columns

cvl_rent2 <- cvl_rent2 |>
  mutate(RentTaxRatio = MedianRentE/MedianTaxesE, 
         RentTaxRatioMOE = moe_ratio(MedianRentE, MedianTaxesE, MedianRentM, MedianTaxesM)) |>
  mutate(County = case_when(
    str_detect(GEOID, "51540") ~ "Charlottesville", 
    str_detect(GEOID, "51109") ~ "Louisa",
    str_detect(GEOID, "51125") ~ "Nelson",
    str_detect(GEOID, "51065") ~ "Fluvanna",
    str_detect(GEOID, "51003") ~ "Albemarle",
    str_detect(GEOID, "51079") ~ "Greene",
  )) |>
  select(1, 2, 13, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12)



write.csv(cvl_rent2, "C:/Users/smang/OneDrive/Housing Justice DJA/rentexploitationproject/Data Cleaning/Housing_Data.csv", row.names = FALSE)
write.csv(IncomeByTenure, "C:/Users/smang/OneDrive/Housing Justice DJA/rentexploitationproject/Data Cleaning/Income_By_Tenure.csv", row.names = FALSE)
write.csv(Tenure, "C:/Users/smang/OneDrive/Housing Justice DJA/rentexploitationproject/Data Cleaning/Tenure.csv", row.names = FALSE)
write.csv(TenureByIncome, "C:/Users/smang/OneDrive/Housing Justice DJA/rentexploitationproject/Data Cleaning/Tenure_By_Income.csv", row.names = FALSE)



